// Load environment variables
require('dotenv').config();

// Fallback for Phusion Passenger
if (!process.env.NODE_ENV) {
  process.env.NODE_ENV = 'production';
}

// Debug environment variables
console.log('üîç Environment Debug:');
console.log('NODE_ENV:', process.env.NODE_ENV);
console.log('PORT:', process.env.PORT);
console.log('DB_HOST:', process.env.DB_HOST);
console.log('APP_URL:', process.env.APP_URL);
console.log('Current working directory:', process.cwd());
console.log('__dirname:', __dirname);

const express = require('express');
const mysql = require('mysql2/promise');
const session = require('express-session');
const FileStore = require('session-file-store')(session);
const path = require('path');
const helmet = require('helmet');
const compression = require('compression');
const cors = require('cors');
const expressLayouts = require('express-ejs-layouts');
const dbConfig = require('./config/database');
const SiteSettings = require('./models/SiteSettings');
const MenuItems = require('./models/MenuItems');

// Helper function to generate breadcrumbs
function generateBreadcrumbs(path, query, menuStructure, articleTitle = null) {
  const breadcrumbs = [
    { title: 'Strona g≈Ç√≥wna', url: '/', isActive: false }
  ];

  // Strona g≈Ç√≥wna
  if (path === '/') {
    breadcrumbs[0].isActive = true;
    return breadcrumbs;
  }

  // Sprawd≈∫ czy to hierarchiczny URL (parent/child)
  const hierarchicalMatch = path.match(/^\/([^\/]+)\/(.+)$/);
  if (hierarchicalMatch) {
    const [, parentSlug, childSlug] = hierarchicalMatch;
    
    // Znajd≈∫ parent menu item
    const parentItem = menuStructure.find(item => item.slug === parentSlug);
    if (parentItem) {
      // Dodaj parent jako link
      breadcrumbs.push({
        title: parentItem.title,
        url: `/${parentItem.slug}`,
        isActive: false
      });
      
      // Najpierw sprawd≈∫ czy child to submenu item
      let childItem = null;
      if (parentItem.children) {
        childItem = parentItem.children.find(child => child.slug === childSlug);
      }
      
      if (childItem) {
        // To jest submenu item - dodaj go do breadcrumbs
        breadcrumbs.push({
          title: childItem.title,
          url: `/${parentItem.slug}/${childItem.slug}`,
          isActive: false
        });
        
        // Je≈õli mamy tytu≈Ç artyku≈Çu, dodaj go jako aktywny
        if (articleTitle) {
          breadcrumbs.push({
            title: articleTitle,
            url: '',
            isActive: true
          });
        } else {
          // Je≈õli nie ma tytu≈Çu artyku≈Çu, submenu item jest aktywny
          breadcrumbs[breadcrumbs.length - 1].isActive = true;
          breadcrumbs[breadcrumbs.length - 1].url = '';
        }
      } else {
        // Nie znaleziono submenu - mo≈ºe to jest bezpo≈õredni artyku≈Ç
        let childTitle = childSlug;
        if (articleTitle) {
          childTitle = articleTitle;
        } else {
          // Fallback - formatuj slug
          childTitle = childSlug.split('-').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
          ).join(' ');
        }
        
        breadcrumbs.push({
          title: childTitle,
          url: '',
          isActive: true
        });
      }
      
      return breadcrumbs;
    }
  }

  // Znajd≈∫ odpowiedni element w menu (istniejƒÖca logika)
  function findMenuItemByPath(items, searchPath, searchQuery = {}) {
    for (const item of items) {
      // Sprawd≈∫ czy to URL menu item (np. /menu/123)
      const menuMatch = searchPath.match(/^\/menu\/(\d+)$/);
      if (menuMatch) {
        const menuId = parseInt(menuMatch[1]);
        if (item.id === menuId) {
          return item;
        }
        // Sprawd≈∫ tak≈ºe w children
        if (item.children) {
          for (const child of item.children) {
            if (child.id === menuId) {
              return { parent: item, child: child };
            }
          }
        }
      }

      // NAJPIERW sprawd≈∫ dzieci (submenu) - to ma priorytet
      if (item.children && item.children.length > 0) {
        // Sprawd≈∫ czy to aktualno≈õci z parametrem kategoria
        if (item.slug === 'aktualnosci' && searchPath === '/aktualnosci' && searchQuery.kategoria) {
          // Dekoduj parametr kategoria z URL
          const decodedKategoria = decodeURIComponent(searchQuery.kategoria);
          const child = item.children.find(child => child.slug === decodedKategoria);
          if (child) {
            return { parent: item, child: child };
          }
        }
        
        // Sprawd≈∫ inne dzieci
        for (const child of item.children) {
          if (`/${child.slug}` === searchPath) {
            return { parent: item, child: child };
          }
        }
      }
      
      // DOPIERO POTEM sprawd≈∫ g≈Ç√≥wnƒÖ pozycjƒô (tylko je≈õli nie ma query parametr√≥w)
      if (`/${item.slug}` === searchPath && Object.keys(searchQuery).length === 0) {
        return item;
      }
    }
    return null;
  }

  const foundItem = findMenuItemByPath(menuStructure, path, query);

  if (foundItem) {
    if (foundItem.parent && foundItem.child) {
      // Submenu - dodaj rodzica i dziecko
      breadcrumbs.push({
        title: foundItem.parent.title,
        url: `/${foundItem.parent.slug}`,
        isActive: false
      });
      breadcrumbs.push({
        title: foundItem.child.title,
        url: '',
        isActive: true
      });
    } else {
      // G≈Ç√≥wna pozycja
      breadcrumbs.push({
        title: foundItem.title,
        url: '',
        isActive: true
      });
    }
  } else {
    // Fallback - spr√≥buj na podstawie slug
    const slug = path.substring(1); // usu≈Ñ '/' z poczƒÖtku
    
    if (slug) {
      // Capitalize pierwszƒÖ literƒô i zamie≈Ñ my≈õlniki na spacje
      const title = slug.split('-').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
      
      breadcrumbs.push({
        title: title,
        url: '',
        isActive: true
      });
    }
  }

  return breadcrumbs;
}

const app = express();
const PORT = process.env.PORT || 3000;
const APP_URL = process.env.APP_URL || process.env.BASE_URL || `http://localhost:${PORT}`;

// Trust proxy for correct IP detection (important for view tracking)
app.set('trust proxy', true);

// Set view engine
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// Use EJS layouts
app.use(expressLayouts);
app.set('layout', 'layout');
app.set('layout extractScripts', true);
app.set('layout extractStyles', true);

// Make database and site settings available to all views
app.use(async (req, res, next) => {
  res.locals.db = db; // U≈ºywaj globalnej zmiennej db bezpo≈õrednio
  res.locals.appUrl = APP_URL; // URL aplikacji dla link√≥w absolutnych
  
  // Dodaj ustawienia strony i menu do wszystkich widok√≥w
  if (db) {
    try {
      // SiteSettings
      const siteSettings = new SiteSettings(db);
      const settings = await siteSettings.getAll();
      res.locals.siteSettings = settings;
      
      // MenuItems
      const menuItems = new MenuItems(db);
      const menuStructure = await menuItems.getMenuStructure();
      res.locals.menuStructure = menuStructure;
      res.locals.menuItems = menuItems; // Helper dla generowania URL
      
      // Breadcrumbs - przeka≈º articleTitle je≈õli dostƒôpny
      res.locals.breadcrumbs = generateBreadcrumbs(req.path, req.query, menuStructure, res.locals.articleTitle);
      
      // Log tylko pierwszy raz
      if (Object.keys(settings).length > 0 && !req.app.locals.dataLogged) {
        console.log(`‚úÖ SiteSettings za≈Çadowane: ${Object.keys(settings).length} ustawie≈Ñ`);
        console.log(`‚úÖ Menu za≈Çadowane: ${menuStructure.length} pozycji g≈Ç√≥wnych`);
        req.app.locals.dataLogged = true;
      }
    } catch (error) {
      console.error('B≈ÇƒÖd ≈Çadowania danych strony:', error);
      res.locals.siteSettings = {};
      res.locals.menuStructure = [];
      res.locals.menuItems = null;
      res.locals.breadcrumbs = generateBreadcrumbs(req.path, req.query, [], res.locals.articleTitle);
    }
  } else {
    console.log('Brak po≈ÇƒÖczenia z bazƒÖ - u≈ºywam pustych ustawie≈Ñ');
    res.locals.siteSettings = {};
    res.locals.menuStructure = [];
    res.locals.menuItems = null;
    res.locals.breadcrumbs = generateBreadcrumbs(req.path, req.query, []);
  }
  
  next();
});

// Middleware
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
      fontSrc: ["'self'"],
    },
  },
}));
app.use(compression());
app.use(cors());
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(express.static(path.join(__dirname, 'public')));

// Session configuration
const sessionConfig = {
  secret: process.env.SESSION_SECRET || 'your-secret-key-change-in-production',
  resave: false,
  saveUninitialized: false,
  cookie: { 
    secure: process.env.NODE_ENV === 'production',
    maxAge: 24 * 60 * 60 * 1000 // 24 hours
  }
};

// Use FileStore for production, MemoryStore for development
if (process.env.NODE_ENV === 'production') {
  try {
    const FileStore = require('session-file-store')(session);
    sessionConfig.store = new FileStore({
      path: './sessions',
      ttl: 24 * 60 * 60, // 24 hours
      retries: 5
    });
    console.log('‚úÖ Using FileStore for sessions (production)');
  } catch (error) {
    console.log('‚ö†Ô∏è  FileStore not available, using MemoryStore (not recommended for production)');
  }
} else {
  console.log('‚úÖ Using MemoryStore for sessions (development)');
}

app.use(session(sessionConfig));

// Database connection
let db = null;

async function connectToDatabase() {
  try {
    db = mysql.createPool({
      host: dbConfig.host,
      user: dbConfig.user,
      password: dbConfig.password,
      database: dbConfig.database,
      port: dbConfig.port,
      connectionLimit: dbConfig.connectionLimit || 10,
      charset: dbConfig.charset || 'utf8mb4'
    });
    
    // Test connection
    const connection = await db.getConnection();
    console.log('‚úÖ Po≈ÇƒÖczono z bazƒÖ danych MySQL');
    console.log('üìä Baza danych:', dbConfig.database);
    console.log('üåê Host:', dbConfig.host);
    console.log('üë§ U≈ºytkownik:', dbConfig.user);
    console.log('üîå Port:', dbConfig.port);
    connection.release();
  } catch (err) {
    console.error('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z MySQL:', err.message);
    console.log('‚ö†Ô∏è  Aplikacja bƒôdzie dzia≈Çaƒá bez bazy danych (tryb offline)');
  }
}

// Initialize database connection
connectToDatabase();

// Routes
app.use('/', require('./routes/main'));
app.use('/admin', require('./routes/admin'));
app.use('/api', require('./routes/api'));

// Error handling middleware
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).render('error', { 
    title: 'B≈ÇƒÖd serwera',
    message: 'WystƒÖpi≈Ç b≈ÇƒÖd serwera. Spr√≥buj ponownie p√≥≈∫niej.',
    error: process.env.NODE_ENV === 'development' ? err : {}
  });
});

// 404 handler
app.use((req, res) => {
  res.status(404).render('error', {
    title: 'Strona nie znaleziona',
    message: 'Strona, kt√≥rej szukasz, nie zosta≈Ça znaleziona.',
    error: {}
  });
});

app.listen(PORT, () => {
  console.log(`Serwer dzia≈Ça na porcie ${PORT}`);
  console.log(`Aplikacja dostƒôpna pod adresem: http://localhost:${PORT}`);
});

module.exports = app;
